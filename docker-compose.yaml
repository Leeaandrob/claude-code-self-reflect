# Claude Self-Reflect Docker Compose
#
# ARCHITECTURE (v9.0.0):
# - Admin Panel: Central monitoring dashboard for all workers
# - Worker Agent: Runs on each machine, reports status to admin
#
# RECOMMENDED SETUP:
# 1. Run Admin Panel on a central server:
#    docker compose --profile admin up -d
#
# 2. Install Worker Agent on each machine:
#    See worker-agent/README.md or run:
#    cd worker-agent && docker compose up -d
#
# LEGACY PROFILES (deprecated - use worker-agent instead):
# - safe-watch: Direct watcher service (replaced by worker-agent)
# - mcp: MCP server via Docker (usually run via Claude Desktop)

volumes:
  qdrant_data:

services:
  # ============================================================================
  # ADMIN PANEL SERVICES (Central Server)
  # ============================================================================

  # Qdrant vector database - required for admin dashboard stats
  qdrant:
    image: qdrant/qdrant:v1.15.1
    container_name: claude-reflection-qdrant
    ports:
      - "${QDRANT_PORT:-6333}:6333"
    volumes:
      - qdrant_data:/qdrant/storage
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}/qdrant-config.yaml:/qdrant/config/config.yaml:ro
    environment:
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__SERVICE__HTTP_PORT=6333
    restart: unless-stopped
    mem_limit: ${QDRANT_MEMORY:-4g}
    memswap_limit: ${QDRANT_MEMORY:-4g}

  # Admin API - FastAPI backend for admin panel
  admin-api:
    build:
      context: .
      dockerfile: Dockerfile.admin-api
    container_name: claude-reflection-admin-api
    depends_on:
      - qdrant
    volumes:
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config:ro
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
    environment:
      - QDRANT_URL=http://qdrant:6333
      - CONFIG_PATH=/config
      - LOGS_DIR=/logs
      - STATE_FILE=/config/unified-state.json
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      - DASHSCOPE_ENDPOINT=${DASHSCOPE_ENDPOINT:-https://dashscope-intl.aliyuncs.com/compatible-mode/v1}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-cloud}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    profiles: ["admin"]
    mem_limit: 512m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Admin Panel - React frontend served by Nginx
  admin:
    build:
      context: .
      dockerfile: Dockerfile.admin
    container_name: claude-reflection-admin
    depends_on:
      - admin-api
      - qdrant
    ports:
      - "${ADMIN_PORT:-3000}:80"
    environment:
      - API_URL=http://admin-api:8000
      - QDRANT_URL=http://qdrant:6333
      - APP_VERSION=${npm_package_version:-1.0.0}
      - NODE_ENV=production
    restart: unless-stopped
    profiles: ["admin"]
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # LEGACY SERVICES (Deprecated - use worker-agent/docker-compose.yaml instead)
  # ============================================================================

  # Fix permissions for config directory (UID 1000 matches local user)
  # DEPRECATED: Use worker-agent which handles this automatically
  init-permissions:
    image: alpine
    command: sh -c "chown -R 1000:1000 /config"
    volumes:
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
    profiles: ["safe-watch", "legacy"]

  # Safe watcher with hot/warm/cold priority
  # DEPRECATED: Use worker-agent/docker-compose.yaml which includes this service
  safe-watcher:
    build:
      context: .
      dockerfile: Dockerfile.safe-watcher
    container_name: claude-reflection-safe-watcher
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/unified-state.json
      - LOGS_DIR=/logs
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - VOYAGE_API_KEY=${VOYAGE_KEY:-}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      - DASHSCOPE_ENDPOINT=${DASHSCOPE_ENDPOINT:-https://dashscope-intl.aliyuncs.com/compatible-mode/v1}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-cloud}
      - MAX_CONCURRENT_EMBEDDINGS=${MAX_CONCURRENT_EMBEDDINGS:-5}
      - ENABLE_MEMORY_DECAY=${ENABLE_MEMORY_DECAY:-false}
      - DECAY_WEIGHT=${DECAY_WEIGHT:-0.3}
      - DECAY_SCALE_DAYS=${DECAY_SCALE_DAYS:-90}
      - IMPORT_FREQUENCY=${IMPORT_FREQUENCY:-30}
      - HOT_CHECK_INTERVAL_S=${HOT_CHECK_INTERVAL_S:-2}
      - HOT_WINDOW_MINUTES=${HOT_WINDOW_MINUTES:-5}
      - WARM_WINDOW_HOURS=${WARM_WINDOW_HOURS:-24}
      - MAX_COLD_FILES=${MAX_COLD_FILES:-20}
      - MAX_WARM_WAIT_MINUTES=${MAX_WARM_WAIT_MINUTES:-30}
      - BATCH_SIZE=${BATCH_SIZE:-30}
      - MAX_MESSAGES_PER_CHUNK=${MAX_MESSAGES_PER_CHUNK:-10}
      - MAX_CHUNK_SIZE=${MAX_CHUNK_SIZE:-50}
      - MEMORY_LIMIT_MB=${MEMORY_LIMIT_MB:-1500}
      - MEMORY_WARNING_MB=${MEMORY_WARNING_MB:-750}
      - MAX_QUEUE_SIZE=${MAX_QUEUE_SIZE:-200}
      - PYTHONUNBUFFERED=1
      - MALLOC_ARENA_MAX=2
    restart: unless-stopped
    profiles: ["safe-watch", "watch", "legacy"]
    mem_limit: 2g
    memswap_limit: 2g
    cpus: 2.0

  # MCP server for Claude integration
  # DEPRECATED: Usually run via Claude Desktop, not Docker
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp-server
    container_name: claude-reflection-mcp
    depends_on:
      - qdrant
    environment:
      - QDRANT_URL=http://qdrant:6333
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY:-}
      - DASHSCOPE_ENDPOINT=${DASHSCOPE_ENDPOINT:-https://dashscope-intl.aliyuncs.com/compatible-mode/v1}
      - EMBEDDING_PROVIDER=${EMBEDDING_PROVIDER:-cloud}
      - ENABLE_MEMORY_DECAY=${ENABLE_MEMORY_DECAY:-true}
      - DECAY_WEIGHT=${DECAY_WEIGHT:-0.3}
      - DECAY_SCALE_DAYS=${DECAY_SCALE_DAYS:-90}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    stdin_open: true
    tty: true
    profiles: ["mcp", "legacy"]

networks:
  default:
    name: claude-reflection-network
    external: false
